<!doctype html>
<html>
    <head>
        <title>Socket.IO chat</title>
        <link rel="stylesheet" type="text/css" href="/index.css" />
    </head>
    <body>
        <form action="" class="login__form">
            <div class="login__wrap">
                <input class="login__input" />
            </div>
        </form>
        <div class="chat">
            <ul class="chat__rooms"></ul>
            <div class="chat__content">
                <ul class="chat__messages"></ul>
                <div class="user-list">
                    <div class="user-list__title">Online</div>
                    <ul class="user-list__content"></ul>
                </div>
                <div class="chat__typing"></div>
            </div>
            <form action="" class="chat__form">
                <input class="chat__input" autocomplete="off" />
                <button>Send</button>
            </form>
        </div>
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
     const socket = io(),
           loginForm = document.querySelector('.login__form'),
           loginInput = document.querySelector('.login__input'),
           chatForm = document.querySelector('.chat__form'),
           chatRooms = document.querySelector('.chat__rooms'),
           chatInput = document.querySelector('.chat__input'),
           chatUserList = document.querySelector('.user-list__content'),
           chatWindow = document.querySelector('.chat__messages'),
           chatTyping = document.querySelector('.chat__typing');

     function login () {
         socket.emit('login', loginInput.value);
     }

     loginForm.addEventListener('submit', e => {
         login();
         e.preventDefault();
     });

     function sendMessage () {
         const msg = chatInput.value;
         if (msg) {
             socket.emit('chat message', msg);
             appendMyMessage(msg);
             chatInput.value = '';
         }
     }

     function appendMyMessage (msg) {
         const now = new Date(),
               hours = ('00' + now.getHours()).substr(-2,2),
               minutes = ('00' + now.getMinutes()).substr(-2,2);

         receiveMessage(`[${hours}:${minutes}] You: ${msg}`);
     }

     chatForm.addEventListener('submit', e => {
         sendMessage();
         e.preventDefault();
     });

     let typingTimeout;

     function _onTyping () {
         clearTimeout(typingTimeout);
         socket.emit('typingMessage', { 'isTyping': true });
         typingTimeout = setTimeout(typingTimeoutFunction, 3000);
     }

     chatInput.addEventListener('keyup', e => {
         if (e.keyCode === '13') {
             sendMessage();
         } else {
             _onTyping();
         }
     });

     function receiveMessage (msg) {
         const messageNode = document.createElement('li'),
               messageTextNode = document.createTextNode(msg);

         messageNode.appendChild(messageTextNode);
         chatWindow.appendChild(messageNode);
     }

     socket.on('chat message', receiveMessage);

     function _onLogin (roomName) {
         const roomNode = document.createElement('li'),
               roomTextNode = document.createTextNode(roomName);

         roomNode.appendChild(roomTextNode);
         roomNode.classList.add('chat__room');
         roomNode.classList.add('chat__room_active');
         chatRooms.appendChild(roomNode);

         loginForm.classList.add('login__form_hidden');
     }

     socket.on('login', _onLogin);

     function _onUserLeave (username) {
         const userToRemove = chatUserList.querySelector(`li[data-username="${username}"]`);

         if (userToRemove)
             userToRemove.remove();
     }

     socket.on('user leave', _onUserLeave);

     function _onUserJoin (username) {
         const userNode = document.createElement('li'),
               userTextNode = document.createTextNode(username);

         userNode.appendChild(userTextNode);
         userNode.dataset.username = username;
         chatUserList.appendChild(userNode);
     }

     socket.on('user join', _onUserJoin);

     function _getUserList (userList) {
         chatUserList.innerHTML = '';
         userList.forEach(user => {
             _onUserJoin(user);
         });
     }

     socket.on('user list', _getUserList);

     function _onUserTyping (user) {
         if (user.isTyping) {
             const newUserTyping = `${user.name} is typing...`;

             if (chatTyping.innerHTML !== newUserTyping) {
                 chatTyping.innerHTML = newUserTyping;
             }

             chatTyping.classList.remove('chat__typing_hidden');
         } else {
             chatTyping.classList.add('chat__typing_hidden');
         }
     }

     function typingTimeoutFunction (){
         socket.emit('typingMessage', { isTyping: false });
     }

     socket.on('typingMessage', _onUserTyping);
    </script>
</html>
